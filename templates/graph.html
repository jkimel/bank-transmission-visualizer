{% extends "base.html" %}

{% block title %}Visualización de Grafo - Transmisiones Bancarias{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.css" rel="stylesheet">
<link href="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.css" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="fas fa-project-diagram me-2"></i>Visualización del Recorrido
                </h4>
                <a href="{{ url_for('table_page') }}" class="btn btn-dark btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Volver a la Tabla
                </a>
            </div>
            <div class="card-body">
                <!-- Información de la Fila Seleccionada -->
                <div id="rowInfo" class="alert alert-info d-none">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Entidad:</strong> <span id="infoEntidad">-</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Sistema Origen:</strong> <span id="infoOrigen">-</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Sistema Destino:</strong> <span id="infoDestino">-</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Riesgo:</strong> <span id="infoRiesgo">-</span>
                        </div>
                    </div>
                </div>

                <!-- Contenedor del Grafo -->
                <div id="cy"></div>

                <!-- Controles del Grafo -->
                <div class="graph-controls">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="btn-group btn-group-sm">
                                <button id="layoutDagre" class="btn btn-outline-primary active">
                                    <i class="fas fa-arrow-right me-1"></i> Izquierda a Derecha
                                </button>
                                <button id="resetView" class="btn btn-outline-secondary">
                                    <i class="fas fa-crosshairs me-1"></i> Centrar Vista
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="legend">
                                <div class="legend-item">
                                    <div class="legend-color entity-color"></div>
                                    <span>Entidad</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color system-color"></div>
                                    <span>Sistema</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color edge-low"></div>
                                    <span>Riesgo Bajo</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color edge-medium"></div>
                                    <span>Riesgo Medio</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color edge-high"></div>
                                    <span>Riesgo Alto</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información de Interacción -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-info-circle me-2"></i>Instrucciones de Interacción</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="small mb-2"><strong>Zoom:</strong> Rueda del mouse o gesto de pellizco</p>
                        <p class="small mb-2"><strong>Pan:</strong> Arrastrar el fondo del grafo</p>
                        <p class="small mb-2"><strong>Mover nodos:</strong> Arrastrar cualquier nodo</p>
                    </div>
                    <div class="col-md-6">
                        <p class="small mb-2"><strong>Información:</strong> Pasa el mouse sobre nodos o aristas</p>
                        <p class="small mb-2"><strong>Resaltar conexiones:</strong> Haz clic en un nodo</p>
                        <p class="small mb-2"><strong>Reiniciar vista:</strong> Usa el botón "Centrar Vista"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
<script>
class GraphVisualizer {
    constructor() {
        this.cy = null;
        this.currentLayout = 'dagre';
        this.rowId = {{ row_id | tojson }};
        this.currentTooltip = null;
        
        this.initializeCytoscape();
        this.loadGraphData();
        this.initializeEventListeners();
    }

    initializeCytoscape() {
        this.cy = cytoscape({
            container: document.getElementById('cy'),
            elements: [],
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#1e3a8a',
                        'label': 'data(id)',
                        'width': 'data(tamaño)',
                        'height': 'data(tamaño)',
                        'font-size': '12px',
                        'color': '#fff',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'border-width': 2,
                        'border-color': '#0f172a',
                        'text-outline-width': 2,
                        'text-outline-color': '#1e3a8a'
                    }
                },
                {
                    selector: 'node[tipo="Entidad"]',
                    style: {
                        'background-color': '#1e3a8a',
                        'shape': 'round-rectangle'
                    }
                },
                {
                    selector: 'node[tipo="Sistema"]',
                    style: {
                        'background-color': '#64748b',
                        'shape': 'ellipse'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 'mapData(peso, 1, 3, 2, 6)',
                        'line-color': 'mapData(peso, 1, 3, #10b981, #ef4444)',
                        'target-arrow-color': 'mapData(peso, 1, 3, #10b981, #ef4444)',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(tipo)',
                        'font-size': '10px',
                        'color': '#374151',
                        'text-rotation': 'autorotate',
                        'text-margin-y': -5
                    }
                },
                {
                    selector: 'edge:selected',
                    style: {
                        'line-color': '#d4af37',
                        'target-arrow-color': '#d4af37'
                    }
                },
                {
                    selector: 'node:selected',
                    style: {
                        'border-color': '#d4af37',
                        'border-width': 4
                    }
                },
                {
                    selector: '.highlighted',
                    style: {
                        'border-color': '#d4af37',
                        'border-width': 4,
                        'line-color': '#d4af37',
                        'target-arrow-color': '#d4af37'
                    }
                }
            ],
            layout: this.getLayoutConfig('dagre')
        });

        // Tooltips
        this.cy.on('mouseover', 'node, edge', (evt) => {
            const ele = evt.target;
            const data = ele.data();
            let content = '';
            
            if (ele.isNode()) {
                content = `
                    <strong>${data.id}</strong><br>
                    Tipo: ${data.tipo}<br>
                    Conexiones: ${data.grado}
                `;
            } else {
                content = `
                    <strong>${data.tipo}</strong><br>
                    Transmisión: ${data.tipo_transmision}<br>
                    Propietario: ${data.propietario}<br>
                    Riesgo: ${data.riesgo}
                `;
            }
            
            this.showTooltip(evt, content);
        });

        this.cy.on('mouseout', 'node, edge', () => {
            this.hideTooltip();
        });

        // Highlight connections on node click
        this.cy.on('tap', 'node', (evt) => {
            const node = evt.target;
            this.highlightConnectedElements(node);
        });
    }

    async loadGraphData() {
        if (!this.rowId) {
            this.showError('No se especificó ID de fila');
            return;
        }

        try {
            const response = await fetch(`/api/graph?row_id=${this.rowId}`);
            const result = await response.json();

            if (response.ok) {
                this.cy.elements().remove();
                this.cy.add(result.elements);
                this.applyLayout(this.currentLayout);
                this.updateRowInfo(result.row_data);
            } else {
                this.showError('Error cargando grafo: ' + result.error);
            }
        } catch (error) {
            this.showError('Error de conexión: ' + error.message);
        }
    }

    updateRowInfo(rowData) {
        document.getElementById('infoEntidad').textContent = rowData.Entidad;
        document.getElementById('infoOrigen').textContent = rowData['Sistema de origen'];
        document.getElementById('infoDestino').textContent = rowData['Sistema de Destino'];
        document.getElementById('infoRiesgo').textContent = rowData['Riesgo de falla'];
        document.getElementById('rowInfo').classList.remove('d-none');
    }

    initializeEventListeners() {
        document.getElementById('layoutDagre').addEventListener('click', () => {
            this.currentLayout = 'dagre';
            this.updateLayoutButtons();
            this.applyLayout('dagre');
        });

        document.getElementById('resetView').addEventListener('click', () => {
            this.cy.reset();
            this.cy.fit();
        });
    }

    updateLayoutButtons() {
        document.getElementById('layoutDagre').classList.toggle('active', this.currentLayout === 'dagre');
    }

    applyLayout(layoutName) {
        const layout = this.cy.layout(this.getLayoutConfig(layoutName));
        layout.run();
    }

    getLayoutConfig(layoutName) {
        const configs = {
            dagre: {
                name: 'dagre',
                rankDir: 'LR',  // ← CAMBIADO: Left to Right (Izquierda a Derecha)
                spacingFactor: 1.5,
                nodeSep: 100,   // ← Aumentado para mejor separación horizontal
                rankSep: 150,   // ← Aumentado para mejor separación vertical
                fit: true,
                padding: 50,
                align: 'UL',
                ranker: 'network-simplex',
                minLen: function(edge) { return 1; },
                edgeWeight: function(edge) { return 1; }
            }
        };
        return configs[layoutName];
    }

    highlightConnectedElements(node) {
        this.cy.elements().removeClass('highlighted');
        
        const connectedEdges = node.connectedEdges();
        const connectedNodes = node.neighborhood();
        
        connectedEdges.addClass('highlighted');
        connectedNodes.addClass('highlighted');
    }

    showTooltip(evt, content) {
        const tooltip = document.createElement('div');
        tooltip.className = 'cy-tooltip';
        tooltip.innerHTML = content;
        
        document.body.appendChild(tooltip);
        
        const updatePosition = (e) => {
            tooltip.style.left = (e.originalEvent.pageX + 10) + 'px';
            tooltip.style.top = (e.originalEvent.pageY + 10) + 'px';
        };
        
        updatePosition(evt);
        this.currentTooltip = { element: tooltip, updatePosition };
        
        // Actualizar posición mientras se mueve el mouse
        this.cy.on('mousemove', 'node, edge', updatePosition);
    }

    hideTooltip() {
        if (this.currentTooltip) {
            this.currentTooltip.element.remove();
            this.currentTooltip = null;
            this.cy.off('mousemove');
        }
    }

    showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.card-body').prepend(alert);
    }
}

// Inicializar el visualizador cuando la página cargue
document.addEventListener('DOMContentLoaded', function() {
    window.graphVisualizer = new GraphVisualizer();
});
</script>
{% endblock %}